name: openstack/glance/glance-api
enabled: {{ enable_glance | bool }}
container:
  image: "{{ glance_api_image }}:{{ glance_api_tag }}"
service:
  daemon:
    dependencies: [glance_ansible_tasks/create_database,
                   glance_ansible_tasks/database_user_create,
                   glance-api/db_sync]
    command: glance-api
  mem: {{ api_endpoint_mem }}
  cpus: {{ api_endpoint_cpus }}

commands:
  db_sync:
    run_once: True
    dependencies: [glance_ansible_tasks/create_database,
                   glance_ansible_tasks/database_user_create]
    command: kolla_extend_start
    env:
      KOLLA_BOOTSTRAP:
    files:
      glance.conf.j2:
        source: ["config/glance/templates/glance-api.conf.j2",
                 "config/glance/templates/glance-file.conf.j2",
                 "/etc/kolla-mesos/config/global.conf",
                 "/etc/kolla-mesos/config/database.conf",
                 "/etc/kolla-mesos/config/messaging.conf",
                 "/etc/kolla-mesos/config/glance.conf",
                 "/etc/kolla-mesos/config/glance/glance-api.conf"]
        dest: /etc/glance/glance-api.conf
        owner: glance
        perm: "0600"
