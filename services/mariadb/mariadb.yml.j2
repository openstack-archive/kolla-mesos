{% set mysql_dir = 'mysql' if kolla_base_distro in ['ubuntu', 'debian'] else '' %}
name: infra/mariadb/mariadb
container:
  image: "{{ mariadb_image }}:{{ mariadb_tag }}"
service:
  daemon:
    command: /usr/bin/mysqld_safe --wsrep-new-cluster
    dependencies: [mariadb/bootstrap]

commands:
  bootstrap:
    run_once: True
    command: kolla_extend_start
    env:
      KOLLA_BOOTSTRAP:
      DB_ROOT_PASSWORD: "{{ database_password }}"
      DB_MAX_TIMEOUT: "{{ database_max_timeout }}"
    files:
      galera.cnf.j2:
        source: config/mariadb/templates/galera.cnf.j2
        dest: /etc/{{ mysql_dir }}/my.cnf
        owner: mysql
        perm: "0600"
