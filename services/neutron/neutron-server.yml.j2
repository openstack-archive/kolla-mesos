name: openstack/neutron/neutron-server
enabled: {{ enable_neutron | bool }}
container:
  image: "{{ neutron_server_image }}:{{ neutron_server_tag }}"
service:
  daemon:
    dependencies: [neutron-server/db_sync, neutron_ansible_tasks/create_user, rabbitmq/daemon]
    command: neutron-server --config-file /etc/neutron/neutron.conf --config-file /etc/neutron/plugins/ml2/ml2_conf.ini
    files:
      neutron.conf.j2:
        source: ["config/neutron/templates/neutron.conf.j2",
                 {% if neutron_plugin_agent == 'linuxbridge' %}
                 "config/neutron/templates/neutron.linuxbridge.conf.j2"
                 {% elif neutron_plugin_agent == 'openvswitch' %}
                 "config/neutron/templates/neutron.openvswitch.conf.j2"
                 {% endif %}]
        dest: /etc/neutron/neutron.conf
        owner: neutron
        perm: "0600"
      ml2_conf.ini.j2:
        source: ["config/neutron/templates/ml2_conf.ini.j2",
                 {% if neutron_plugin_agent == 'linuxbridge' %}
                 "config/neutron/templates/ml2_conf.linuxbridge.ini.j2"
                 {% elif neutron_plugin_agent == 'openvswitch' %}
                 "config/neutron/templates/ml2_conf.openvswitch.ini.j2"
                 {% endif %}]
        dest: /etc/neutron/plugins/ml2/ml2_conf.ini
        owner: neutron
        perm: "0600"
  mem: {{ neutron_server_mem }}
  cpus: {{ neutron_server_cpus }}

commands:
  db_sync:
    run_once: True
    dependencies: [neutron_ansible_tasks/create_database,
                   neutron_ansible_tasks/database_user_create]
    command: bash kolla_extend_start
    env:
      KOLLA_BOOTSTRAP:
    files:
      neutron.conf.j2:
        source: ["config/neutron/templates/neutron.conf.j2",
                 {% if neutron_plugin_agent == 'linuxbridge' %}
                 "config/neutron/templates/neutron.linuxbridge.conf.j2"
                 {% elif neutron_plugin_agent == 'openvswitch' %}
                 "config/neutron/templates/neutron.openvswitch.conf.j2"
                 {% endif %}]
        dest: /etc/neutron/neutron.conf
        owner: neutron
        perm: "0600"
      ml2_conf.ini.j2:
        source: ["config/neutron/templates/ml2_conf.ini.j2",
                 {% if neutron_plugin_agent == 'linuxbridge' %}
                 "config/neutron/templates/ml2_conf.linuxbridge.ini.j2"
                 {% elif neutron_plugin_agent == 'openvswitch' %}
                 "config/neutron/templates/ml2_conf.openvswitch.ini.j2"
                 {% endif %}]
        dest: /etc/neutron/plugins/ml2/ml2_conf.ini
        owner: neutron
        perm: "0600"
