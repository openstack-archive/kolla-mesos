{% set keystone_cmd = 'apache2' if kolla_base_distro in ['ubuntu', 'debian'] else 'httpd' %}
{% set keystone_dir = 'apache2/conf-enabled' if kolla_base_distro in ['ubuntu', 'debian'] else 'httpd/conf.d' %}
config:
  keystone:
    keystone:
      kolla_mesos_start.py:
        source: config/kolla_mesos_start.py
        dest: /usr/local/bin/kolla_mesos_start
      wsgi-keystone.conf.j2:
        source: config/keystone/templates/wsgi-keystone.conf.j2
        dest: /etc/keystone/keystone.conf
        owner: keystone
        perm: "0600"
      keystone.conf.j2:
        source: ["/etc/kolla/config/global.conf",
                 "/etc/kolla/config/database.conf",
                 "/etc/kolla/config/messaging.conf",
                 "config/keystone/templates/keystone.conf.j2",
                 "/etc/kolla/config/keystone.conf"]
        dest: /etc/{{ keystone_dir }}/keystone.conf
        owner: keystone
        perm: "0600"
      extend_start.sh.j2:
        source: config/keystone/templates/extend_start.sh.j2
        dest: /usr/local/bin/kolla_mesos_extend_start
        owner: keystone
        perm: "0755"
    keystone_bootstrap:
      kolla_mesos_start.py:
        source: config/kolla_mesos_start.py
        dest: /usr/local/bin/kolla_mesos_start
commands:
  keystone:
    keystone:
      bootstrap:
        run_once: True
        requires: [/kolla/variables/keystone_database/.done,
                   /kolla/variables/keystone_database_user_create/.done]
        register: /kolla/variables/keystone_bootstrap/.done
        command: kolla_extend_start
      final:
        run_once: False
        requires: [/kolla/variables/keystone_database/.done,
                   /kolla/variables/keystone_database_user_create/.done,
                   /kolla/variables/keystone_bootstrap/.done]
        command: "/usr/sbin/{{ keystone_cmd }} -DFOREGROUND"
    keystone_bootstrap:
      create_database:
        run_once: True
        requires: [/kolla/variables/mariadb_bootstrap/.done]
        register: /kolla/variables/keystone_database/.done
        command: /usr/bin/ansible localhost
                 -m mysql_db
                 -a "login_host='{{ database_address }}'
                     login_port='{{ mariadb_port }}'
                     login_user='{{ database_user }}'
                     login_password='{{ database_password }}'
                     name='{{ keystone_database_name }}'"
      database_user_create:
        run_once: True
        requires: [/kolla/variables/keystone_database/.done]
        register: /kolla/variables/keystone_database_user_create/.done
        command: /usr/bin/ansible localhost
          -m mysql_user
          -a "login_host='{{ database_address }}'
              login_port='{{ mariadb_port }}'
              login_user='{{ database_user }}'
              login_password='{{ database_password }}'
              name='{{ keystone_database_name }}'
              password='{{ keystone_database_password }}'
              host='%'
              priv='{{ keystone_database_name }}.*:ALL'
              append_privs='yes'"
