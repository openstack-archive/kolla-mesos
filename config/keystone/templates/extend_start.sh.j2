#!/bin/bash

if [[ "${KOLLA_BASE_DISTRO}" == "ubuntu" || \
        "${KOLLA_BASE_DISTRO}" == "debian" ]]; then
    # Loading Apache2 ENV variables
    source /etc/apache2/envvars
fi

# NOTE(pbourke): httpd will not clean up after itself in some cases which
# results in the container not being able to restart. Unconfirmed if this
# happens on Ubuntu. (bug #1489676)
if [[ "${KOLLA_BASE_DISTRO}" =~ fedora|centos|oraclelinux|rhel ]]; then
    rm -rf /var/run/httpd/* /run/httpd/* /tmp/httpd*
fi

sudo -H -u keystone keystone-manage db_sync
# Start the api to set initial endpoint and users with the admin_token
/usr/sbin/{{ keystone_cmd }}
KEYSTONE_PID=$!

sleep 5

PUBLIC_URL="http://{{ kolla_external_address }}:{{ keystone_public_port }}/v2.0"
INTERNAL_URL="http://{{ kolla_internal_address }}:{{ keystone_public_port }}/v2.0"
ADMIN_URL="http://{{ kolla_internal_address }}:{{ keystone_admin_port }}/v2.0"
OS_URL="http://{{ hostvars[inventory_hostname]['ansible_' + api_interface]['ipv4']['address'] }}:{{ keystone_admin_port }}/v2.0"

openstack service create --name keystone --description "OpenStack Identity" identity
openstack endpoint create --region "{{ openstack_region_name }}" \
                                --publicurl "${PUBLIC_URL}" \
                                --internalurl "${INTERNAL_URL}" \
                                --adminurl "${ADMIN_URL}" \
                                identity
openstack project create --description "Admin Project" admin
openstack user create --password "{{ keystone_admin_password }}" admin
openstack role create admin
openstack role add --project admin --user admin admin

kill $KEYSTONE_PID
exit 0
