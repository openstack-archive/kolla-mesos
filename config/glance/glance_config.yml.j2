config:
  glance:
    glance-api:
      glance-api.conf.j2:
        source: ["config/glance/templates/glance-api.conf.j2",
{% if enable_ceph | bool %}
                 "config/glance/templates/glance-ceph.conf.j2",
{% else %}
                 "config/glance/templates/glance-file.conf.j2",
{% endif %}
                 "/etc/kolla-mesos/config/global.conf",
                 "/etc/kolla-mesos/config/database.conf",
                 "/etc/kolla-mesos/config/messaging.conf",
                 "/etc/kolla-mesos/config/glance.conf",
                 "/etc/kolla-mesos/config/glance/glance-api.conf"]
        dest: /etc/glance/glance-api.conf
        owner: glance
        perm: "0600"
    glance-registry:
      glance-registry.conf.j2:
        source: ["config/glance/templates/glance-registry.conf.j2",
                 "/etc/kolla-mesos/config/global.conf",
                 "/etc/kolla-mesos/config/database.conf",
                 "/etc/kolla-mesos/config/messaging.conf",
                 "/etc/kolla-mesos/config/glance.conf",
                 "/etc/kolla-mesos/config/glance/glance-registry.conf"]
        dest: /etc/glance/glance-registry.conf
        owner: glance
        perm: "0600"
commands:
  glance:
    glance-api:
      db_sync:
        run_once: True
        requires: [/kolla/{{ deployment_id }}/variables/glance_database/.done,
                   /kolla/{{ deployment_id }}/variables/glance_database_user_create/.done]
        register: /kolla/{{ deployment_id }}/variables/glance_setup/.done
        env:
          KOLLA_BOOTSTRAP:
        command: kolla_extend_start
      glance_api:
        daemon: True
        requires: [/kolla/{{ deployment_id }}/variables/glance_user/.done,
                   /kolla/{{ deployment_id }}/variables/keystone_running/.done]
        command: /usr/bin/glance-api
    glance-registry:
      glance-registry:
        daemon: True
        requires: [/kolla/{{ deployment_id }}/variables/glance_user/.done,
                   /kolla/{{ deployment_id }}/variables/keystone_running/.done]
        command: /usr/bin/glance-registry
    glance_ansible_tasks:
      create_database:
        run_once: True
        requires: [/kolla/{{ deployment_id }}/variables/mariadb_bootstrap/.done]
        register: /kolla/{{ deployment_id }}/variables/glance_database/.done
        command: {{ ansible_task_cmd }}
          -m mysql_db
          -a "login_host='{{ database_address }}'
              login_port='{{ mariadb_port }}'
              login_user='{{ database_user }}'
              login_password='{{ database_password }}'
              name='{{ glance_database_name }}'"
      database_user_create:
        run_once: True
        requires: [/kolla/{{ deployment_id }}/variables/glance_database/.done]
        register: /kolla/{{ deployment_id }}/variables/glance_database_user_create/.done
        command: {{ ansible_task_cmd }}
          -m mysql_user
          -a "login_host='{{ database_address }}'
              login_port='{{ mariadb_port }}'
              login_user='{{ database_user }}'
              login_password='{{ database_password }}'
              name='{{ glance_database_name }}'
              password='{{ glance_database_password }}'
              host='%'
              priv='{{ glance_database_name }}.*:ALL'
              append_privs='yes'"
      register_endpoint:
        run_once: True
        requires: [/kolla/{{ deployment_id }}/variables/glance_setup/.done,
                   /kolla/{{ deployment_id }}/variables/keystone_running/.done]
        register: /kolla/{{ deployment_id }}/variables/glance_api_registered/.done
        command: {{ ansible_task_cmd }}
          -m kolla_keystone_service
          -a "service_name=glance
              service_type=image
              description='Openstack Image'
              endpoint_region={{ openstack_region_name }}
              admin_url='http://{{ kolla_internal_address }}:{{ glance_api_port }}'
              internal_url='http://{{ kolla_internal_address }}:{{ glance_api_port }}'
              public_url='http://{{ kolla_external_address }}:{{ glance_api_port }}'
              region_name={{ openstack_region_name }}
              auth={{ '{{ openstack_glance_auth }}' }}"
          -e "{'openstack_glance_auth':{{ openstack_glance_auth }}}"
      create_glance_user:
        run_once: True
        requires: [/kolla/{{ deployment_id }}/variables/glance_setup/.done,
                   /kolla/{{ deployment_id }}/variables/keystone_running/.done]
        register: /kolla/{{ deployment_id }}/variables/glance_user/.done
        command: {{ ansible_task_cmd }}
          -m kolla_keystone_user
          -a "project=service
              user=glance
              password={{ glance_keystone_password }}
              role=admin
              region_name={{ openstack_region_name }}
              auth={{ '{{ openstack_glance_auth }}' }}"
          -e "{'openstack_glance_auth':{{ openstack_glance_auth }}}"
      sanity_check:
        run_once: True
        retries: 10
        delay: 5
        requires: [/kolla/{{ deployment_id }}/variables/glance_setup/.done,
                   /kolla/{{ deployment_id }}/variables/keystone_running/.done]
        register: /kolla/{{ deployment_id }}/variables/glance_running/.done
        command: {{ ansible_task_cmd }}
          -m kolla_sanity
          -a "service=glance
              project=service
              user=glance
              password={{ glance_keystone_password }}
              role=admin
              region_name={{ openstack_region_name }}
              auth={{ '{{ openstack_glance_auth }}' }}"
          -e "{'openstack_glance_auth':{{ openstack_glance_auth }}}"
